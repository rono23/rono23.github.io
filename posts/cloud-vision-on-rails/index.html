<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><title>RailsでCloud Visionのテキスト認識と顔検出 - rono23</title><link rel="alternate" type="application/atom+xml" title="rono23 - Atom Feed" href="/posts/feed.xml" /><link href="/stylesheets/all-74d75e74.css" rel="stylesheet" /><script src="/javascripts/all-da39a3ee.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-845284-7', 'auto');
  ga('send', 'pageview');
</script>
</head><body><div class="header clear"><div class="l-constrained"><h1><a href="/">rono23</a></h1><ul><li><a href="/about">About</a></li></ul></div></div><div class="hero" style="background-image: url('/images/hero/default-71bf53ff.jpg')"></div><div class="main"><div class="l-constrained"><div class="post-date">April  1, 2021</div><div class="post-title">RailsでCloud Visionのテキスト認識と顔検出</div><div class="markdown"><p><a href="https://cloud.google.com/vision/docs/quickstarts">Quickstarts</a>を参考にセットアップ後、サービスアカウントの秘密鍵ファイルを適当に設置（<code>config/xxx.json</code>）。</p>

<pre><code># Gemfile
gem &#39;google-cloud-vision&#39;

# config/initializers/cloud_vision.rb
credentials = JSON.parse File.read(Rails.root.join(&#39;config&#39;, &#39;xxx.json&#39;))
Google::Cloud::Vision.configure do |config|
  config.credentials = credentials
end
</code></pre>

<p>viewに <code>file_field :image</code> みたいの書いてファイルをアップロードしてみる。</p>

<pre><code># controller
image = File.binread(params[:image].tempfile)

requests = [{
  image: { content: image },
  # image: { source: { image_uri: &#39;https://example.com/image.png&#39; } },
  image_context: { language_hints: %w(ja) },
  features: [
    { type: :FACE_DETECTION },
    { type: :TEXT_DETECTION }
  ]
}]

result = Google::Cloud::Vision.image_annotator.batch_annotate_images(requests: requests)
</code></pre>

<p>簡単！<code>File.binread</code> を知らなくて、ちょっとはまったけど…<br>
<a href="https://cloud.google.com/vision/docs/drag-and-drop">デモ</a>でどんな感じか試せるし、レスポンスのJSONも見れて便利だけど、日本語のテキスト検出を試したい場合はローカルで <code>language_hints</code> で <code>ja</code> を指定して試してみるのおすすめです。精度がちょっと上がりました。</p>

<h2>参考</h2>

<ul>
<li><a href="https://cloud.google.com/vision/docs/drag-and-drop">Try it! | Cloud Vision API</a></li>
<li><a href="https://cloud.google.com/vision/docs/features-list">Features list | Cloud Vision API</a></li>
<li><a href="https://cloud.google.com/vision/docs/reference/rest/v1/Feature#type">Feature | Cloud Vision API</a></li>
<li><a href="https://googleapis.dev/ruby/google-cloud-vision-v1/latest/Google/Cloud/Vision/V1.html">Module: Google::Cloud::Vision::V1</a></li>
</ul>

<hr>

<p><a href="https://aws.amazon.com/jp/rekognition/">Amazon Rekognition</a>は日本語のテキスト検出がまだサポートされてなかったので今回見送ったけど、サポートされたら試してみたい。</p>
</div><div class="post-comment"><p><a href="https://github.com/rono23/rono23.github.io/issues/new?title=[cloud-vision-on-rails]%20">Post a comment on GitHub</a></p></div><div class="post-tags"><ul class="inline"><li>Tags:</li><li><a href="/posts/tags/rails/">rails</a></li></ul></div></div></div><div class="footer"><div class="l-constrained"><div class="copy">&copy; 2022 rono23</div></div></div></body></html>