<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><title>Capybara WebkitからHeadless Chromeに移行 - rono23</title><link rel="alternate" type="application/atom+xml" title="rono23 - Atom Feed" href="/posts/feed.xml" /><link href="/stylesheets/all-42c2128f.css" rel="stylesheet" /><script src="/javascripts/all-da39a3ee.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-845284-7', 'auto');
  ga('send', 'pageview');
</script>
</head><body><div class="header clear"><div class="l-constrained"><h1><a href="/">rono23</a></h1><ul><li><a href="/about">About</a></li></ul></div></div><div class="hero" style="background-image: url('/images/hero/default-71bf53ff.jpg')"></div><div class="main"><div class="l-constrained"><div class="post-date">September 11, 2017</div><div class="post-title">Capybara WebkitからHeadless Chromeに移行</div><div class="markdown"><p>インストール</p>

<pre><code># Gemfile
group :test do
  gem &#39;selenium-webdriver&#39;
  gem &#39;chromedriver-helper&#39;
  ...
end
</code></pre>

<p><code>chromedriver</code> は <code>brew install chromedriver</code> するか、上記のようにgemでインストールすると楽だけど、gemの場合、<a href="https://github.com/flavorjones/chromedriver-helper#updating-to-latest-chromedriver">アップデート</a>について少し念頭に入れておいたほうがいいかも。<br>
CircleCIだとimageに <code>circleci/ruby:2.4.1-node-browsers</code> を指定していれば <code>chromedriver</code> とか色々と入れてくれて、特に設定等しなくても動く。</p>

<p>設定</p>

<pre><code># spec/rails_helper.rb
require &#39;selenium/webdriver&#39;

...

Capybara.register_driver :headless_chrome do |app|
  capabilities = Selenium::WebDriver::Remote::Capabilities.chrome(
    chromeOptions: { args: %w(headless disable-gpu window-size=1280,800) }
  )

  Capybara::Selenium::Driver.new app, browser: :chrome, desired_capabilities: capabilities
end
Capybara.javascript_driver = :headless_chrome
</code></pre>

<p>修正が必要だったのは <code>trigger</code>, <code>alert</code>, <code>drag_to</code> 周りで、最新のバージョンだと <code>save_and_open_screenshot</code> も正常に動作しました。</p>

<p>Versions</p>

<pre><code>/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --version
Google Chrome 61.0.3163.79

chromedriver -v
ChromeDriver 2.32.498537
</code></pre>

<p><code>trigger</code> の削除</p>

<pre><code># before
find(&#39;i.icon-cancel&#39;).trigger(&#39;click&#39;)

# after
find(&#39;i.icon-cancel&#39;).click
</code></pre>

<p><code>alert</code> の修正</p>

<pre><code># before
click_button I18n.t(:subscribe)

# after
accept_confirm { click_button I18n.t(:subscribe) }
</code></pre>

<p><code>drag_to</code> の修正</p>

<p>以下のような条件があると <code>drag_to</code> が動かなくなったので、CSSで <code>width</code> を大きめに設定したら動いた。</p>

<ul>
<li><code>&lt;span class=&#39;draggable&#39;&gt;&lt;i class=&#39;fa fa-arrows-v&#39;&gt;&lt;/i&gt;&lt;/span&gt;</code> ようなアイコンだけ</li>
<li>CSSで <code>.draggable { position: absolute; right: -100px; }</code> みたいなこと</li>
<li>window サイズが未設定（上記設定で <code>window-size=1280,800</code> したのはこのため）</li>
</ul>

<p>参考</p>

<ul>
<li><a href="https://developers.google.com/web/updates/2017/04/headless-chrome?hl=ja">ヘッドレス Chrome ことはじめ</a></li>
<li><a href="https://robots.thoughtbot.com/headless-feature-specs-with-chrome">Headless Capybara Feature Specs with Chrome</a></li>
<li><a href="https://sites.google.com/a/chromium.org/chromedriver/getting-started">ChromeDriver - WebDriver for Chrome</a></li>
<li><a href="https://github.com/flavorjones/chromedriver-helper">flavorjones/chromedriver-helper</a></li>
</ul>
</div><div class="post-comment"><p><a href="https://github.com/rono23/rono23.github.io/issues/new?title=[replace-capybara-webkit-with-headless-chrome]%20">Post a comment on GitHub</a></p></div><div class="post-tags"><ul class="inline"><li>Tags:</li><li><a href="/posts/tags/rails/">rails</a></li></ul></div></div></div><div class="footer"><div class="l-constrained"><div class="copy">&copy; 2020 rono23</div></div></div></body></html>