<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><title>Appleでサインインのアクセストークンとリフレッシュトークンの取得 - rono23</title><link rel="alternate" type="application/atom+xml" title="rono23 - Atom Feed" href="/posts/feed.xml" /><link href="/stylesheets/all-74d75e74.css" rel="stylesheet" /><script src="/javascripts/all-da39a3ee.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-845284-7', 'auto');
  ga('send', 'pageview');
</script>
</head><body><div class="header clear"><div class="l-constrained"><h1><a href="/">rono23</a></h1><ul><li><a href="/about">About</a></li></ul></div></div><div class="hero" style="background-image: url('/images/hero/default-71bf53ff.jpg')"></div><div class="main"><div class="l-constrained"><div class="post-date">February 19, 2020</div><div class="post-title">Appleでサインインのアクセストークンとリフレッシュトークンの取得</div><div class="markdown"><p><a href="/posts/verify-sign-in-with-apple-token/">Appleでサインインのトークン検証</a>の続き。</p>

<h4>セットアップ</h4>

<pre><code># Gemfile
gem &quot;jwt&quot;

# クライアントから送られてきたパラメータ
code = &quot;authorizationCode&quot;

# アプリのID（decoded_token[:aud]）
client_id = &quot;com.example.app&quot;

# https://developer.apple.com/account/#/membership
team_id = &quot;xxx&quot;

# https://developer.apple.com/account/resources/authkeys/list
key_id = &quot;xxx&quot;
key_file = File.read(Rails.root.join(&quot;AuthKey_xxx.p8&quot;))
key = OpenSSL::PKey::EC.new(key_file)
</code></pre>

<h4><code>access_token/refresh_token</code> の取得</h4>

<pre><code>headers = {
  kid: key_id,
  alg: &quot;ES256&quot;
}
claims = {
  iss: team_id,
  sub: client_id,
  iat: Time.now.to_i,
  exp: Time.now.to_i + 1.day.to_i * 180,
  aud: &quot;https://appleid.apple.com&quot;
}
client_secret = JWT.encode claims, key, &quot;ES256&quot;, headers
params = {
  client_id: client_id,
  client_secret: client_secret,
  code: code,
  grant_type: &quot;authorization_code&quot;
}
response = Net::HTTP.post_form(URI.parse(&quot;https://appleid.apple.com/auth/token&quot;), params)
json = JSON.parse(response.body, symbolize_names: true)
#=&gt; {:access_token=&gt;&quot;xxx&quot;, :token_type=&gt;&quot;Bearer&quot;, :expires_in=&gt;3600, :refresh_token=&gt;&quot;xxx&quot;, :id_token=&gt;&quot;xxx&quot;}
</code></pre>

<h4><code>refresh_token</code> を利用して <code>access_token</code> を取得</h4>

<pre><code>params = {
  client_id: client_id,
  client_secret: client_secret,
  refresh_token: json[:refresh_token],
  grant_type: &quot;refresh_token&quot;
}
response = Net::HTTP.post_form(URI.parse(&quot;https://appleid.apple.com/auth/token&quot;), params)
json = JSON.parse(response.body, symbolize_names: true)
#=&gt; {:access_token=&gt;&quot;xxx&quot;, :token_type=&gt;&quot;Bearer&quot;, :expires_in=&gt;3600}
</code></pre>

<h4>リンク</h4>

<ul>
<li><a href="https://developer.apple.com/documentation/signinwithapplerestapi/generate_and_validate_tokens">Generate and validate tokens - Sign in with Apple REST API</a></li>
<li><a href="https://developer.apple.com/documentation/signinwithapplerestapi/tokenresponse">TokenResponse - Sign in with Apple REST API</a></li>
<li><a href="https://developer.apple.com/documentation/signinwithapplerestapi/errorresponse">ErrorResponse - Sign in with Apple REST API</a></li>
</ul>
</div><div class="post-comment"><p><a href="https://github.com/rono23/rono23.github.io/issues/new?title=[sign-in-with-apple-tokens]%20">Post a comment on GitHub</a></p></div><div class="post-tags"><ul class="inline"><li>Tags:</li><li><a href="/posts/tags/ios/">ios</a></li><li><a href="/posts/tags/ruby/">ruby</a></li></ul></div></div></div><div class="footer"><div class="l-constrained"><div class="copy">&copy; 2022 rono23</div></div></div></body></html>